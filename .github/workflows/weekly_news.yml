name: Weekly PubMed News

on:
  schedule:
    # Ogni lunedÃ¬ alle 8:00 UTC
    - cron: "0 8 * * 1"
  workflow_dispatch:
    inputs:
      date:
        description: "Data override (YYYY-MM-DD), default: oggi"
        required: false
      threshold:
        description: "Soglia rilevanza minima (1-10), default: 7"
        required: false
        default: "7"

permissions:
  contents: write

jobs:
  fetch-news:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Restore analysis cache
        uses: actions/cache@v4
        with:
          path: scripts/.news_cache.json
          key: news-cache-${{ github.run_id }}
          restore-keys: news-cache-

      - name: Fetch & analyze PubMed articles
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NCBI_EMAIL: "orto_pedia_bot@github.com"
        run: |
          ARGS=""
          if [ -n "${{ github.event.inputs.date }}" ]; then
            ARGS="$ARGS --date ${{ github.event.inputs.date }}"
          fi
          if [ -n "${{ github.event.inputs.threshold }}" ]; then
            ARGS="$ARGS --threshold ${{ github.event.inputs.threshold }}"
          fi
          python scripts/fetch_news.py $ARGS

      - name: Commit & Push if changed
        id: push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/news/
          if git diff --staged --quiet; then
            echo "Nessun nuovo contenuto da committare."
            echo "pushed=false" >> "$GITHUB_OUTPUT"
          else
            DATE=$(date +%Y-%m-%d)
            git commit -m "docs(news): rassegna settimanale ${DATE}"
            git push
            echo "pushed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Trigger deploy
        if: steps.push.outputs.pushed == 'true'
        run: gh workflow run deploy.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
